# CatchaFire Backend - Order Management with PostgreSQL & CSV

A FastAPI backend for order management with PostgreSQL database storage, CSV file generation, and location-based delivery validation.

## Architecture

### Core Components

- **`main.py`** - FastAPI application with order and CSV endpoints
- **`database.py`** - PostgreSQL connection and SQLAlchemy setup
- **`order_model.py`** - SQLAlchemy Order model for database operations
- **`csv_order_service.py`** - Business logic for orders, database saves, and CSV updates
- **`models.py`** - Pydantic models for API validation
- **`doordash_bulk_orders.csv`** - CSV file for 3rd party delivery integration

### Key Features

- **Dual Storage**: Orders saved to PostgreSQL database AND CSV file simultaneously
- **Database Fallback**: ✅ IMPLEMENTED - If database unavailable, gracefully falls back to CSV-only operation
- **Random Quantity Generation**: When database unavailable, generates random quantities (1-10) for realistic testing
- **Dynamic Price Calculation**: Total price calculated as sum of (quantity × unit_price) for all items
- **Multi-Item Orders**: Support for multiple different products in single order
- **Dynamic Customer IDs**: Customer_id comes from authenticated user account
- **Auto-generated Order IDs**: Sequential order_id assignment in database
- **Default Values**: Empty product names default to "Unknown Product"
- **Location-Based Time**: Order timestamps use UTC time (extensible for timezone detection)
- **CSV File Management**: Automatic CSV updates for delivery integration
- **Pydantic Validation**: Type-safe API request/response validation
- **Location Validation**: GPS-based delivery radius checking (Task 2)
- **South Africa Ready**: Configured for Johannesburg market coordinates

## Quick Start

1. **Install Dependencies**

   ```bash
   pip install -r requirements.txt
   ```

2. **Database Setup (Optional)**

   If PostgreSQL is available:

   ```bash
   createdb orders_db
   # Update DATABASE_URL in database.py if needed
   ```

   If PostgreSQL is NOT available, the system will automatically operate in **CSV-only fallback mode**.

3. **Create Database Tables (Optional)**

   ```bash
   python -c "from database import engine, Base; Base.metadata.create_all(bind=engine)"
   # Skip if database is not available - system works in CSV-only mode
   ```

4. **Start Server**
   ```bash
   uvicorn main:app --reload --host 127.0.0.1 --port 8000
   ```

## API Endpoints

### GET /

Returns API information and available endpoints.

**Response:**

```json
{
  "message": "Task 1 - CSV Order Management API",
  "endpoints": {
    "POST /orders/": "Create new order (database + CSV)",
    "GET /orders/": "Get all orders from database",
    "POST /csv-orders/": "Create CSV order (backward compatibility)",
    "GET /csv-orders/": "Get CSV orders from file"
  },
  "csv_columns": [
    "order_id",
    "customer_id",
    "product_name",
    "quantity",
    "total_price",
    "order_time"
  ]
}
```

### POST /orders/

Creates a new order, saves to PostgreSQL database, and updates CSV file.

**Request Body:**

```json
{
  "customer_id": 1,
  "product_name": "Fresh Apples", // Optional: defaults to "Unknown Product" if empty
  "quantity": 5,
  "total_price": 25.0,
  "order_time": "2025-01-14T10:00:00"
}
```

**Notes:**

- `customer_id`: Provided by frontend from authenticated user account
- `order_id`: Auto-generated by backend if not provided
- `product_name`: Optional field, defaults to "Unknown Product" if empty
- `order_time`: UTC timestamp provided by frontend (location-aware for future enhancement)

**Response:**

```json
{
  "message": "Order created successfully",
  "order_id": 1,
  "order_details": {
    "order_id": 1,
    "customer_id": 1,
    "product_name": "Fresh Apples",
    "quantity": 5,
    "total_price": 25.0,
    "order_time": "2025-01-14T10:00:00"
  },
  "database_saved": true,
  "csv_updated": true,
  "fallback_mode": false
}
```

**Fallback Response (when database unavailable):**

```json
{
  "message": "Order created successfully",
  "order_id": 1,
  "order_details": {
    "order_id": 1,
    "customer_id": 1,
    "product_name": "Fresh Apples",
    "quantity": 5,
    "total_price": 25.0,
    "order_time": "2025-01-14T10:00:00"
  },
  "database_saved": false,
  "csv_updated": true,
  "fallback_mode": true
}
```

### GET /orders/

Retrieves all orders from the PostgreSQL database, with automatic fallback to CSV data if database is unavailable.

**Response:**

```json
[
  {
    "order_id": 1,
    "customer_id": 1,
    "product_name": "Fresh Apples",
    "quantity": 5,
    "total_price": 25.0,
    "order_time": "2025-01-14T10:00:00"
  }
]
```

### POST /csv-orders/ & GET /csv-orders/

Legacy endpoints for backward compatibility - work with CSV file only.
"GET /csv-orders/": "Get all CSV orders"
},
"csv_columns": [
"order_id",
"customer_id",
"product_name",
"quantity",
"total_price",
"order_time"
]
}

````

### POST /csv-orders/

Creates a new CSV order and updates the CSV file.

**Request Body:**

```json
{
  "customer_id": 1,
  "product_name": "Fresh Apples",
  "quantity": 5,
  "total_price": 25.0,
  "order_time": "2025-01-14T10:00:00"
}
````

**Response:**

```json
{
  "message": "CSV Order created successfully",
  "order_id": 1,
  "order_details": {
    "order_id": 1,
    "customer_id": 1,
    "product_name": "Fresh Apples",
    "quantity": 5,
    "total_price": 25.0,
    "order_time": "2025-01-14T10:00:00"
  },
  "csv_updated": true
}
```

### GET /csv-orders/

Retrieves all CSV orders from memory (loaded from CSV file).

**Response:**

```json
[
  {
    "order_id": 1,
    "customer_id": 1,
    "product_name": "Fresh Apples",
    "quantity": 5,
    "total_price": 25.0,
    "order_time": "2025-01-14T10:00:00"
  }
]
```

## CSV File Format

Orders are stored in `doordash_bulk_orders.csv` with these columns:

| Column       | Type  | Description                                    |
| ------------ | ----- | ---------------------------------------------- |
| order_id     | int   | Auto-generated unique identifier               |
| customer_id  | int   | Customer identifier (currently hardcoded to 1) |
| product_name | str   | Name of the ordered product                    |
| quantity     | int   | Number of items ordered                        |
| total_price  | float | Total price of the order                       |
| order_time   | str   | ISO timestamp when order was created           |

## Data Flow

1. **Frontend** collects: product_name, quantity, total_price
2. **Frontend** sends: customer_id (1), product_name, quantity, total_price, order_time (current)
3. **Backend** generates: order_id (auto-increment)
4. **Backend** validates data with Pydantic
5. **Backend** appends to CSV file
6. **Frontend** shows success popup with order details

## Future Enhancements

- User authentication integration
- DoorDash API integration
- Order status tracking
- Bulk order processing
- Database migration (from CSV to PostgreSQL)
  ```
  **[backend/main.py#L29-L38](backend/main.py#L29-L38) - Startup event handler**
  ```

## API Endpoints

### Orders

- `POST /orders/` - Create new order

### DoorDash Bulk Orders

- `POST /doordash/bulk-orders/update` - Manual CSV update
- `GET /doordash/bulk-orders/summary` - Get CSV statistics
- `GET /doordash/bulk-orders/download` - Download CSV file
- `POST /doordash/bulk-orders/start-scheduler` - Start automated updates
- `POST /doordash/bulk-orders/stop-scheduler` - Stop automated updates

### Health

- `GET /health` - Health check

## Configuration

All configuration is centralized in `config.py`. Override with environment variables:

```bash
export DB_HOST=your_host
export DOORDASH_DEVELOPER_ID=your_id
export LOG_LEVEL=DEBUG
```

## Development

### Adding New Features

1. **Database Operations**: Add methods to `DatabaseManager` in `database.py`
2. **Business Logic**: Add methods to appropriate service classes
3. **API Endpoints**: Add routes to `main.py` with proper documentation
4. **Configuration**: Add settings to `config.py`

### Testing

#### Random Quantity & Price Calculation (Fallback Mode)

When PostgreSQL is unavailable, the system generates realistic test data:

**Single Item Orders:**

- Quantity: Randomly generated (1-10)
- Unit Price: Based on product type ($5 Fresh Apples, $7.50 Bananas, etc.)
- Total Price: `quantity × unit_price`

**Multi-Item Orders:**

- Each item gets random quantity (1-10)
- Total Price: Sum of `(quantity × unit_price)` for all items
- Supports unlimited different products per order

**Example Fallback Response:**

```json
{
  "fallback_mode": true,
  "order_details": {
    "items": [
      {
        "product_name": "Fresh Apples",
        "quantity": 4, // Randomly generated
        "unit_price": 5.0
      },
      {
        "product_name": "Organic Bananas",
        "quantity": 7, // Randomly generated
        "unit_price": 7.5
      }
    ],
    "total_price": 72.5 // 4×5.00 + 7×7.50
  }
}
```

- Install PostgreSQL and dependencies
- Orders saved to both database and CSV
- Response shows `"database_saved": true, "fallback_mode": false`

2. **Without Database (Fallback Mode)**:
   - Run without SQLAlchemy/psycopg2
   - Orders saved to CSV only
   - Response shows `"database_saved": false, "fallback_mode": true`

**Test Fallback Mode:**

```bash
# Install only core dependencies (no database)
pip install fastapi uvicorn pydantic pandas requests PyJWT schedule

# Start server - will show "operating in CSV-only mode"
uvicorn main:app --reload

# Test order creation
curl -X POST http://localhost:8000/orders/ \
  -H "Content-Type: application/json" \
  -d '{"customer_id": 123, "product_name": "Test Product", "quantity": 1, "total_price": 10.99, "order_time": "2025-01-14T10:00:00"}'
```

**Expected Fallback Response:**

```json
{
  "message": "Order created successfully",
  "order_id": 7,
  "database_saved": false,
  "csv_updated": true,
  "fallback_mode": true
}
```

#### Unit Testing

```bash
# Run with test database
export DB_NAME=test_orders_db
python -m pytest
```

## DoorDash Integration

- Uses sandbox environment for development
- JWT authentication with automatic token refresh
- Bulk CSV generation for manual upload to DoorDash portal
- Automated updates every 15 minutes (configurable)

## Database Schema

### Orders Table

```sql
- order_id (SERIAL PRIMARY KEY)
- customer_id (INTEGER)
- product_name (VARCHAR)
- quantity (INTEGER)
- total_price (DECIMAL)
- delivery_address (TEXT)
- delivery_partner (VARCHAR)
- customer_phone (VARCHAR)
- customer_name (VARCHAR)
- currency (VARCHAR DEFAULT 'ZAR')
-- ... additional fields
```

### Customers Table

```sql
- customer_id (SERIAL PRIMARY KEY)
- name (VARCHAR)
- phone_number (VARCHAR)
- email (VARCHAR)
- address (TEXT)
```

## Logging

Structured logging with configurable levels:

- INFO: General operations
- ERROR: Failures and exceptions
- DEBUG: Detailed debugging info

## Security

- JWT tokens for DoorDash API (5-minute expiry)
- Environment variable configuration
- No hardcoded secrets
- Input validation via Pydantic models
